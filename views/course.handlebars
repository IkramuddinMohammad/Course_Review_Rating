<main>
    <div class="card-wide" id="sticky">
        <h1>{{course.courseId}}, {{course.name}}</h1>
        <p>credits: {{course.credits}}</p>
        <p>Professor: {{course.professorname}}, Email:{{course.professoremail}} </p>
        <p>TA: {{course.taname}}, Email: {{course.taemail}}</p>
        <p class="avg">{{course.rating}}/5 ({{course.reviews.length}} Reviews)</p>
        {{#each semsVal}}
        <p>{{this.val}} {{this.semrat}} </p>
        {{/each}}
    </div>

    <div class="card-wide" id="right">
        <h2>Reviews</h2>
        {{#each reviews}}
        <div class="reviews">
            <div class="card-full">
                <div class="reviewHeading">
                    <div class="reviewerName">
                        <h3 class="p_inline"><a href="/students/{{this.student._id}}">{{this.student.firstName}}
                                {{this.student.lastName}}</a></h3>
                    </div>
                    <div class="reviewerRating">
                        <h3 class="rating">Rating: {{this.rating}}/5</h3>
                    </div>
                </div>


                <p>{{this.reviewText}}</p>

                {{#if this.isStudentReviewer}}
                {{#if this.studentLoggedIn}}
                <div class="dropdown">
                    <button class="dropbtn">Options</button>
                    <div class="dropdown-content">
                        <p><a href="../reviews/{{this._id}}/edit">Edit Review</a></p>
                        <p><a href="../reviews/{{this.courseId}}/{{this._id}}/delete">Delete Review</a></p>
                    </div>
                </div>
                {{/if}}
                {{/if}}
                <h4>Comments</h4>
                <div class="comments">
                    {{#if ../studentLoggedIn}}
                    <form id="login-form" name="loginForm" class="form-container"
                        action="/comments/{{../currentStudentsData._id}}/{{this._id}}/{{this.courseId}}/add"
                        method="POST">
                        <label>
                            <input type="textarea" name="commentValue" id="commentValue" class="inputFields"
                                placeholder="Write a comment..." rows="3" required />
                        </label>
                        <button type="submit" class="btn">Submit</button>
                    </form>
                    {{/if}}
                    {{#each this.commentList}}
                    <div class="card-full" id="white-card">
                        <p class="p_inline"><a href="../students/{{this.student._id}}">{{this.student.firstName}}
                                {{this.student.lastName}}</a></p>
                        <p id="comment-value-tag-{{@index}}">{{this.commentText}}</p>
                        {{#if this.isComment}}
                        <form id="comment-form-{{@index}}" name="loginForm" class="comment-container"
                            action="/comments/{{this.courseId}}/{{this._id}}/edit" method="POST">
                            <label>
                                <input type="textarea" name="commentValue" id="commentValue" class="inputFields"
                                    placeholder="Edit your comment..." required />
                            </label>
                            <button type="submit" class="btn">Post!</button>
                            <button type="button" class="btn cancel"
                                onclick="javascript:commentBoxEditForm('{{@index}}');">Cancel</button>
                        </form>
                        {{#if this.isStudentReviewer}}
                        {{#if this.studentLoggedIn}}
                        <div class="dropdown">
                            <button class="dropbtn">Options</button>
                            <div class="dropdown-content">
                                <p><a href="javascript:commentBoxEditForm('{{@index}}');">Edit Comment</a></p>
                                <p><a href="/comments/{{this.courseId}}/{{this._id}}/delete">Delete Comment</a></p>
                            </div>
                        </div>
                        {{/if}}
                        {{/if}}
                        {{/if}}
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
        {{/each}}
    </div>
    {{#if studentLoggedIn}}
    {{#if currentStudentsData.reviewedcoursePage}}
    <button class="open-button" onclick="openAlert()">Add a Review</button>
    {{else}}
    <button class="open-button" onclick="openReviewForm()">Add a Review</button>
    {{/if}}
    {{else if adminLoggedIn}}
    <button class="open-button" onclick="openCourseEdit()">Edit course</button>
    {{else}}
    <button class="open-button" onclick="openLoginForm()">Add a Review</button>
    {{/if}}
    <div class="form-popup" id="reviewForm">
        <h2>Add a Review</h2>
        <form method="POST" action="/reviews/{{course._id}}/add">
            <p> Select semester:
                <select name="selectSemester" id="selectSemester">
                    <option name="fall2022" value="fall2022">Fall 2022</option>
                    <option name="spring2022" value="spring2022">Spring 2022</option>
                    <option name="fall2021" value="fall2021">Fall 2021</option>
                </select>
            </p>
            <label>
                <input type="text" name="rating" id="rating" class="inputFields" pattern="\d+"
                    placeholder="Enter your Rating" required title="Enter a Number from 1 to 5" />
            </label>
            <label>
                <input type="text" name="reviewText" id="reviewText" class="inputFields" placeholder="Enter your Review"
                    required />
            </label>
            <button type="submit" class="btn">Add Review</button>
            <button type="button" class="btn cancel" onclick="closeForm()">Cancel</button>
        </form>
    </div>
    <div class="form-popup" id="myLoginForm">
        <h2>Login to add a review!</h2>
        <form id="login-form" name="loginForm" class="form-container" action="javascript:void(0);">
            <button type="submit" class="btn" id="routeToLogin">Login</button>
            <button type="button" class="btn cancel" onclick="closeLoginForm()">Cancel</button>
        </form>
    </div>
    <div class="form-popup" id="myAlert">
        <p>You have already added a Review! <br> You can edit your Review Above.</p>
        <form id="login-form" name="loginForm" class="form-container" action="javascript:void(0);">
            <button type="button" class="btn cancel" onclick="closeAlert()">Close</button>
        </form>
    </div>
    <div class="form-popup" id="editcourseForm">
        <h2>Edit course</h2>
        <form id="login-form" name="loginForm" class="form-container" action="javascript:void(0);">
            <button type="submit" class="btn" id="routeToEdit">Edit Course</button>
            <button type="button" class="btn cancel" onclick="closeLoginForm()">Cancel</button>
        </form>
    </div>
    <div>
        {{#if isError}}
        <div class="error">
            <ul>
                {{#each error}}
                <li>
                    {{this}}
                </li>
                {{/each}}
            </ul>
        </div>
        {{/if}}
    </div>
    <script>
        function openLoginForm() {
            document.getElementById("myLoginForm").style.display = "block";
        }
        function closeLoginForm() {
            document.getElementById("myLoginForm").style.display = "none";
        }
        function openReviewForm() {
            document.getElementById("reviewForm").style.display = "block";
        }
        function closeReviewForm() {
            document.getElementById("reviewForm").style.display = "none";
        }
        function openCourseEdit() {
            document.getElementById("editcourseForm").style.display = "block";
        }
        function closeCourseEdit() {
            document.getElementById("editcourseForm").style.display = "none";
        }
        function openAlert() {
            document.getElementById("myAlert").style.display = "block";
        }
        function closeAlert() {
            document.getElementById("myAlert").style.display = "none";
        }
        function openCommentBox() {
            document.getElementById("row-override").style.display = "block";
        }
        function commentBoxEditForm(index) {
            var formElement = "comment-form-" + index;

            var x = document.getElementById(formElement);
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }
        }

        function closeCommentBox() {
            document.getElementById("row-override").style.display = "none";
        }

        document.getElementById("routeToLogin").onclick = function () {
            location.href = "/students/login";
        };

        document.getElementById("routeToEdit").onclick = function () {
            location.href = "/courses/edit";
        };

    </script>
</main>